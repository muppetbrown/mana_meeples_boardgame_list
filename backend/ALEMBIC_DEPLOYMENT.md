# Alembic Migration Deployment Guide

## Overview

This project now uses Alembic for database migrations instead of in-code migrations. This provides better version control, easier rollbacks, and clearer migration history.

## First-Time Deployment (Production)

Since the production database already has the complete schema, we need to mark the initial migration as applied without actually running it:

### Step 1: Deploy the Code

The code has already been updated to:
- ✅ Add Alembic to requirements.txt
- ✅ Initialize Alembic configuration
- ✅ Remove in-code migrations from database.py
- ✅ Update render.yaml to run migrations on startup

### Step 2: Mark Initial Migration as Applied

After the code is deployed but BEFORE any new migrations are created, SSH into the Render instance or run this command:

```bash
cd backend
alembic stamp head
```

This tells Alembic that the database is already at the latest migration state without actually running the migration.

### Step 3: Verify

Check the current migration status:

```bash
alembic current
```

You should see output like:
```
a879cc066239 (head)
```

## Future Migrations

### Creating a New Migration

When you need to change the database schema:

1. **Update the model** in `backend/models.py`

2. **Generate migration** (auto-detect changes):
   ```bash
   cd backend
   alembic revision --autogenerate -m "Add new_column to Game table"
   ```

3. **Review the migration** file in `backend/alembic/versions/`
   - Alembic's autogenerate is smart but not perfect
   - Always review and edit if needed

4. **Test locally**:
   ```bash
   # Apply migration
   alembic upgrade head

   # Test rollback
   alembic downgrade -1

   # Re-apply
   alembic upgrade head
   ```

5. **Commit and push**:
   ```bash
   git add backend/alembic/versions/xxx_add_new_column.py
   git commit -m "Add new_column to Game model"
   git push
   ```

6. **Deploy**: Render will automatically run `alembic upgrade head` on startup

## Common Commands

### Check Migration Status
```bash
alembic current              # Show current revision
alembic history              # Show all migrations
alembic history --verbose    # Detailed history
```

### Apply Migrations
```bash
alembic upgrade head         # Apply all pending migrations
alembic upgrade +1           # Apply next migration
alembic upgrade <revision>   # Upgrade to specific revision
```

### Rollback Migrations
```bash
alembic downgrade -1         # Rollback one migration
alembic downgrade <revision> # Downgrade to specific revision
alembic downgrade base       # Rollback all migrations (DANGEROUS!)
```

## Troubleshooting

### "Target database is not up to date"

The database schema doesn't match the expected migration state.

**Solution**:
```bash
# Check what migration Alembic thinks is applied
alembic current

# Check what migrations exist
alembic history

# If the schema is correct but Alembic doesn't know it:
alembic stamp head
```

### "Can't locate revision identified by 'head'"

No migrations exist in the alembic/versions directory.

**Solution**:
```bash
# Create initial migration
alembic revision --autogenerate -m "Initial schema"
alembic upgrade head
```

### Migration Fails on Render

Check the Render logs for the specific error. Common issues:

1. **Missing environment variables**: Ensure DATABASE_URL is set
2. **Permission errors**: Alembic needs write access to create migration tracking table
3. **Schema conflicts**: The migration may conflict with existing schema

**Recovery**:
```bash
# If a migration partially applied, you may need to:
alembic stamp <previous_revision>  # Reset to working state
alembic upgrade head               # Try again
```

## Migration Best Practices

1. **Review autogenerated migrations**: Always check the generated SQL
2. **Test locally first**: Run upgrade and downgrade before deploying
3. **One logical change per migration**: Makes rollbacks easier
4. **Descriptive names**: Use clear migration messages
5. **Data migrations**: Add data transformations when needed
6. **Backup before risky migrations**: Consider backing up production data

## Example: Adding a New Column with Data Migration

```python
"""Add priority column to Game table

Revision ID: abc123
"""

def upgrade():
    # Add column (nullable first)
    op.add_column('boardgames', sa.Column('priority', sa.Integer(), nullable=True))

    # Populate data
    op.execute("""
        UPDATE boardgames
        SET priority = 5
        WHERE priority IS NULL
    """)

    # Make non-nullable
    op.alter_column('boardgames', 'priority', nullable=False)

def downgrade():
    op.drop_column('boardgames', 'priority')
```

## Integration with CI/CD

The `render.yaml` file has been updated to automatically run migrations on deployment:

```yaml
startCommand: cd backend && alembic upgrade head && uvicorn main:app --host 0.0.0.0 --port $PORT
```

This ensures migrations are always applied before the application starts.

## Migration History

- **Initial baseline** (a879cc066239): Complete schema from in-code migrations
  - All tables (boardgames, buy_list_games, price_snapshots, price_offers, sleeves, background_task_failures)
  - All indexes and constraints
  - Status: Applied via `alembic stamp head` on first deployment

## Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [Migration Guide](./ALEMBIC_MIGRATION_GUIDE.md)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
